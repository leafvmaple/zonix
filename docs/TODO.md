# Zonix 操作系统开发 TODO List

> 本文档面向以学习为目的的操作系统开发者，提供循序渐进的开发路线图。

## 📋 项目概览

### 最近更新 (2025-10-14)
- ✨ **多磁盘支持**：实现完整的4磁盘IDE/ATA驱动
  - 支持Primary/Secondary双IDE通道，每通道Master/Slave设备
  - 设备命名：hda（主引导盘）、hdb、hdc、hdd（Linux风格命名）
  - 自动设备检测与初始化
  - 实现带小数精度的lsblk磁盘列表显示（如"4.0M"）
  - Makefile自动创建4个磁盘镜像
  - Bochs配置支持完整的4磁盘环境
  - 块设备层支持多设备注册与管理

- ✨ **性能优化**：修复键盘输入响应慢的问题
  - 实现8259A PIC的EOI信号处理机制
  - 优化Bochs模拟器配置（IPS: 15MHz → 50MHz）
  - 移除时钟同步限制，提升整体运行速度
  - 优化CGA光标更新逻辑

Zonix 是一个基于 x86 架构的教学型操作系统，当前已实现：
- ✅ 基础引导加载（bootloader）
- ✅ 简单的物理内存管理器
- ✅ 中断和异常处理框架（含EOI信号处理）
- ✅ 基础的控制台输出（CGA驱动）
- ✅ 简单的 Shell 框架
- ✅ 键盘输入驱动（优化响应性能）
- ✅ 完整的多磁盘IDE/ATA驱动（支持4设备）
- ✅ 块设备抽象层（支持多设备注册）
- ✅ 交换系统（支持FIFO/Clock/LRU算法）

---

## 🎯 阶段一：核心基础设施（优先级：高）

### 1.1 内存管理增强

#### 物理内存管理
- [ ] **实现 Buddy System 分配器**
  - 文件：创建 `kern/mm/pmm_buddy.c`
  - 参考：当前的 `kern/mm/pmm_firstfit.c` (First-Fit 算法)
  - 目标：减少内存碎片，提高分配效率
  - 学习点：二叉树、位运算、内存对齐

- [ ] **添加 Slab 分配器**
  - 文件：创建 `kern/mm/slab.c`
  - 目标：优化小对象分配
  - 学习点：对象缓存、预分配策略

- [ ] **完善内存统计**
  - 修改：`kern/mm/pmm.c`
  - 添加：总内存、已用内存、空闲内存统计
  - 添加：内存使用历史追踪

#### 虚拟内存管理
- [ ] **实现完整的页表管理**
  - 修改：`kern/mm/vmm.c`
  - 实现：页表创建、销毁、映射、解映射
  - 实现：页表项权限管理（R/W/X）

- [ ] **实现内存区域（VMA）管理**
  - 文件：创建 `kern/mm/vma.c`
  - 结构：定义 vm_area_struct
  - 功能：代码段、数据段、栈、堆的独立管理

- [ ] **实现页面换入换出机制**
  - 完善：`kern/mm/swap.c`
  - 算法：FIFO → Clock → LRU
  - 学习点：页面替换算法、磁盘 I/O

- [ ] **实现 Copy-on-Write**
  - 目标：优化 fork() 性能
  - 学习点：页面保护、缺页处理

- [ ] **添加内存映射文件支持**
  - 实现：mmap() 系统调用
  - 学习点：文件与内存的统一视图

### 1.2 进程管理

#### 进程基础
- [ ] **设计进程控制块（PCB）**
  - 文件：创建 `kern/proc/proc.h`
  - 内容：PID、状态、内存空间、文件描述符、调度信息

- [ ] **实现进程创建**
  - 文件：`kern/proc/proc.c`
  - 实现：`fork()` 系统调用
  - 学习点：地址空间复制、COW 优化

- [ ] **实现进程执行**
  - 实现：`exec()` 系统调用族
  - 学习点：ELF 加载、用户栈初始化
  - 参考：`boot/bootload.c` 中的 ELF 加载

- [ ] **实现进程等待与退出**
  - 实现：`wait()` 和 `exit()` 系统调用
  - 实现：僵尸进程回收
  - 实现：孤儿进程处理

- [ ] **实现进程间关系管理**
  - 添加：父子进程链表
  - 添加：进程树遍历功能

#### 进程调度
- [ ] **实现 Round-Robin 调度器**
  - 修改：`kern/sched/sched.c`
  - 添加：时间片管理
  - 添加：就绪队列管理

- [ ] **实现优先级调度**
  - 添加：静态优先级
  - 添加：动态优先级调整
  - 防止：优先级反转和饥饿

- [ ] **实现 CFS 调度器（进阶）**
  - 学习点：红黑树、虚拟运行时间
  - 目标：实现完全公平调度

- [ ] **添加调度统计信息**
  - 统计：CPU 使用率、上下文切换次数
  - 统计：进程等待时间、周转时间

### 1.3 中断与异常

- [x] **实现中断EOI信号处理** ✅ (2025-10-14)
  - 完成：`kern/trap/trap.c` - 统一EOI发送
  - 完成：`kern/drivers/pic.c` - 实现 pic_send_eoi()
  - 效果：修复键盘响应慢的问题
  - 学习点：8259A PIC工作原理、中断确认机制

- [ ] **完善异常处理**
  - 修改：`kern/trap/trap.c`
  - 添加：详细的异常信息输出
  - 添加：异常堆栈回溯
  - 实现：缺页异常处理

- [ ] **实现中断嵌套**
  - 支持：可重入中断处理
  - 添加：中断优先级管理

- [ ] **添加中断统计**
  - 统计：各类中断的触发次数
  - 提供：/proc/interrupts 接口

---

## 🎯 阶段二：设备与文件系统（优先级：中高）

### 2.1 设备驱动框架

#### 字符设备
- [ ] **完善键盘驱动**
  - 当前：`kern/drivers/kdb.c` 基础键盘驱动已实现
  - 完成：基本扫描码映射、中断响应优化 ✅
  - 待完成：多种键盘布局（US、UK 等）
  - 待完成：组合键（Ctrl、Alt、Shift）
  - 待完成：键盘缓冲区

- [ ] **实现串口驱动**
  - 文件：`kern/drivers/serial.c`
  - 目标：调试输出、远程控制
  - 学习点：UART 编程

- [ ] **实现鼠标驱动**
  - 文件：`kern/drivers/mouse.c`
  - 支持：PS/2 鼠标
  - 学习点：中断驱动的输入处理

#### 块设备
- [x] **多磁盘IDE/ATA驱动** ✅ (2025-10-14)
  - 完成：`kern/drivers/hd.c` - 支持4个IDE设备
  - 完成：Primary/Secondary双通道支持
  - 完成：设备自动检测（hda/hdb/hdc/hdd）
  - 完成：`kern/drivers/blk.c` - 块设备层多设备注册
  - 完成：带小数的磁盘容量显示（lsblk命令）
  - 完成：`Makefile` - 自动创建多磁盘镜像
  - 完成：`bochsrc.bxrc` - 配置4磁盘环境

- [ ] **完善硬盘驱动**
  - 完善：`kern/drivers/hd.c`
  - 待添加：DMA 支持
  - 待添加：异步 I/O
  - 待添加：更完善的错误处理

- [ ] **实现磁盘缓存**
  - 文件：`kern/fs/buffer.c`
  - 算法：LRU 缓存替换
  - 优化：预读、延迟写

#### 显示驱动
- [ ] **完善控制台**
  - 当前：`kern/drivers/cga.c` CGA驱动已实现
  - 完成：基本字符输出、光标更新优化 ✅
  - 待完成：ANSI 转义序列
  - 待完成：颜色支持
  - 待完成：滚动、清屏优化

- [ ] **实现 VGA 图形模式**
  - 文件：`kern/drivers/vga.c`
  - 支持：基本图形绘制（点、线、矩形）
  - 支持：模式切换（文本 ↔ 图形）

- [ ] **实现简单的图形界面**
  - 实现：窗口管理器原型
  - 实现：简单的 GUI 控件

### 2.2 文件系统

#### VFS 层
- [ ] **设计 VFS 接口**
  - 文件：`kern/fs/vfs.h`
  - 定义：inode、dentry、file 结构
  - 定义：文件操作接口

- [ ] **实现文件描述符管理**
  - 实现：fd 分配与回收
  - 实现：fd 表管理
  - 支持：stdin、stdout、stderr

#### 具体文件系统
- [ ] **实现 MinixFS/简单 FS**
  - 文件：`kern/fs/minixfs/`
  - 实现：超级块、inode、数据块管理
  - 实现：目录项管理

- [ ] **实现基本文件操作**
  - 实现：`open()`, `read()`, `write()`, `close()`
  - 实现：`lseek()`, `stat()`
  - 实现：`ioctl()`

- [ ] **实现目录操作**
  - 实现：`mkdir()`, `rmdir()`
  - 实现：`opendir()`, `readdir()`, `closedir()`
  - 实现：路径解析

- [ ] **实现文件权限**
  - 实现：chmod、chown
  - 实现：权限检查

#### 高级特性
- [ ] **实现 ramfs**
  - 目标：内存文件系统
  - 用途：/tmp、/proc

- [ ] **实现 procfs**
  - 提供：/proc/cpuinfo
  - 提供：/proc/meminfo
  - 提供：/proc/[pid]/ 目录

---

## 🎯 阶段三：系统调用与用户态（优先级：中）

### 3.1 系统调用接口

- [ ] **设计系统调用表**
  - 文件：`kern/syscall/syscall.c`
  - 定义：系统调用号
  - 实现：系统调用分发

- [ ] **实现进程相关系统调用**
  ```c
  fork(), exec(), exit(), wait()
  getpid(), getppid()
  sleep(), alarm()
  ```

- [ ] **实现文件相关系统调用**
  ```c
  open(), read(), write(), close()
  creat(), unlink(), link()
  mkdir(), rmdir(), chdir()
  stat(), fstat(), chmod()
  dup(), dup2(), pipe()
  ```

- [ ] **实现内存相关系统调用**
  ```c
  brk(), sbrk()
  mmap(), munmap()
  mprotect()
  ```

- [ ] **实现信号处理系统调用**
  ```c
  signal(), kill()
  sigaction(), sigprocmask()
  ```

- [ ] **添加系统调用追踪**
  - 实现：strace 功能
  - 记录：系统调用参数和返回值

### 3.2 用户态支持

- [ ] **实现用户态切换**
  - 实现：ring3 → ring0 切换
  - 实现：用户栈、内核栈切换

- [ ] **实现用户程序加载器**
  - 解析：ELF 文件格式
  - 参考：`boot/bootload.c`
  - 初始化：用户栈、参数传递

- [ ] **创建简单用户程序**
  - 目录：`user/`
  - 示例：hello、ls、cat、sh

- [ ] **实现动态链接**
  - 实现：动态链接器
  - 支持：共享库加载

---

## 🎯 阶段四：Shell 与工具（优先级：中）

### 4.1 Shell 增强

- [ ] **添加更多内置命令**
  - 完善：`kern/cons/shell.c`
  - 添加：`ls`, `cat`, `echo`, `cd`, `pwd`
  - 添加：`ps`, `kill`, `top`
  - 添加：`mount`, `umount`, `df`

- [ ] **实现命令行编辑**
  - 支持：左右移动光标
  - 支持：删除、插入字符
  - 支持：Home、End 键

- [ ] **实现命令历史**
  - 支持：上下箭头浏览历史
  - 支持：Ctrl-R 搜索历史
  - 持久化：历史记录保存

- [ ] **实现自动补全**
  - 支持：命令补全
  - 支持：文件名补全
  - 支持：Tab 键触发

- [ ] **实现管道和重定向**
  - 实现：`|` 管道
  - 实现：`>`, `>>`, `<` 重定向
  - 实现：`&` 后台执行

- [ ] **实现脚本支持**
  - 支持：.sh 脚本执行
  - 支持：条件判断、循环
  - 支持：变量和函数

### 4.2 系统工具

- [ ] **实现基础工具集**
  ```
  cat, ls, cp, mv, rm, mkdir
  grep, find, sort, uniq
  echo, head, tail, wc
  ```

- [ ] **实现系统监控工具**
  ```
  ps, top, free, df
  uptime, dmesg
  ```

---

## 🎯 阶段五：同步与进程间通信（优先级：中）

### 5.1 同步原语

- [ ] **实现信号量**
  - 文件：`kern/sync/sem.c`
  - 实现：P、V 操作
  - 应用：生产者-消费者

- [ ] **实现互斥锁**
  - 文件：`kern/sync/mutex.c`
  - 实现：lock、unlock
  - 优化：避免自旋

- [ ] **实现条件变量**
  - 文件：`kern/sync/cond.c`
  - 实现：wait、signal、broadcast

- [ ] **实现读写锁**
  - 优化：多读单写场景

### 5.2 进程间通信

- [ ] **实现管道**
  - 实现：匿名管道
  - 实现：命名管道（FIFO）

- [ ] **实现消息队列**
  - 实现：消息发送、接收
  - 实现：消息优先级

- [ ] **实现共享内存**
  - 实现：shmget、shmat、shmdt
  - 学习点：内存共享机制

- [ ] **实现信号**
  - 实现：基本信号处理
  - 实现：信号掩码

---

## 🎯 阶段六：网络与高级特性（优先级：低）

### 6.1 网络支持

- [ ] **实现网络驱动**
  - 驱动：E1000 网卡（QEMU 支持）
  - 学习点：DMA、中断处理

- [ ] **实现网络协议栈**
  - 实现：以太网帧处理
  - 实现：ARP 协议
  - 实现：IP 协议
  - 实现：ICMP（ping）
  - 实现：TCP/UDP（基础）

- [ ] **实现 Socket 接口**
  - 实现：socket()、bind()、listen()
  - 实现：connect()、accept()
  - 实现：send()、recv()

### 6.2 多核支持

- [ ] **实现 SMP 初始化**
  - 检测：CPU 数量
  - 启动：Application Processors (AP)

- [ ] **实现 per-CPU 数据**
  - 设计：每核独立数据结构
  - 优化：减少锁竞争

- [ ] **实现多核调度**
  - 实现：负载均衡
  - 实现：CPU 亲和性

- [ ] **实现 Spinlock**
  - 实现：自旋锁
  - 优化：避免缓存颠簸

### 6.3 64 位支持

- [ ] **迁移到 Long Mode**
  - 修改：引导代码
  - 修改：`tools/boot.ld`、`tools/kernel.ld`
  - 学习点：分页模式变化、寄存器扩展

- [ ] **支持大内存**
  - 支持：超过 4GB 物理内存
  - 修改：内存管理器

### 6.4 安全性

- [ ] **实现用户管理**
  - 实现：用户、组概念
  - 实现：/etc/passwd、/etc/group

- [ ] **实现权限控制**
  - 实现：基于 UID/GID 的权限
  - 实现：文件权限检查

- [ ] **实现 ASLR**
  - 随机化：栈、堆、mmap 地址
  - 目标：提高安全性

---

## 🎯 阶段七：调试、测试与文档（优先级：高）

### 7.1 调试工具

- [ ] **实现内核调试器**
  - 功能：断点、单步
  - 功能：内存查看、寄存器查看
  - 参考：kdb、kgdb

- [ ] **增强 assert 机制**
  - 添加：更详细的错误信息
  - 添加：堆栈回溯

- [ ] **实现内存泄漏检测**
  - 跟踪：内存分配和释放
  - 报告：未释放的内存

- [ ] **实现性能分析工具**
  - 统计：函数调用次数和耗时
  - 实现：简单的 profiler

- [ ] **添加日志系统**
  - 分级：DEBUG、INFO、WARN、ERROR
  - 输出：串口、屏幕、文件

### 7.2 测试框架

- [ ] **建立单元测试框架**
  - 目录：`tests/unit/`
  - 框架：简单的测试宏

- [ ] **为核心模块编写测试**
  - 测试：内存管理器（参考 `kern/mm/pmm_firstfit.c` 的 `check()`）
  - 测试：调度器
  - 测试：文件系统

- [ ] **实现集成测试**
  - 目录：`tests/integration/`
  - 测试：系统调用
  - 测试：多进程交互

- [ ] **添加压力测试**
  - 测试：内存分配压力
  - 测试：进程创建压力
  - 测试：文件 I/O 压力

- [ ] **创建自动化测试脚本**
  - 脚本：`tests/run_tests.sh`
  - 集成：CI/CD（GitHub Actions）

### 7.3 文档完善

- [ ] **更新 README**
  - 完善：`README.md`
  - 添加：项目简介、特性列表
  - 添加：详细构建说明
  - 添加：运行和调试指南

- [ ] **编写架构设计文档**
  - 文档：`docs/architecture.md`
  - 内容：系统架构图
  - 内容：各模块设计思路

- [ ] **编写开发者指南**
  - 文档：`docs/developer_guide.md`
  - 内容：代码规范
  - 内容：提交规范
  - 内容：调试技巧

- [ ] **创建学习路径文档**
  - 文档：`docs/learning_path.md`
  - 内容：推荐学习顺序
  - 内容：每个模块的学习要点
  - 内容：参考资源

- [ ] **为主要模块添加注释**
  - 要求：每个函数添加文档注释
  - 要求：关键算法添加说明
  - 工具：Doxygen 文档生成

### 7.4 代码质量

- [ ] **统一代码风格**
  - 工具：clang-format
  - 配置：`.clang-format` 文件
  - 应用：所有源文件

- [ ] **优化 Makefile**
  - 完善：`Makefile`
  - 添加：依赖自动生成
  - 添加：增量编译优化
  - 添加：更多构建目标

- [ ] **消除代码重复**
  - 工具：PMD、CPD
  - 重构：提取公共函数

- [ ] **完善错误处理**
  - 检查：所有返回值
  - 添加：错误码定义
  - 统一：错误处理风格

---

## 📚 学习建议

### 推荐学习路径

**第一阶段：打好基础（2-3 个月）**
1. 完善物理内存管理（Buddy System）
2. 实现基本的进程创建（fork）
3. 完善调度器（Round-Robin）
4. 实现基础系统调用

**第二阶段：建立生态（3-4 个月）**
1. 实现简单文件系统
2. 完善设备驱动（键盘、硬盘）
3. 扩展 Shell 功能
4. 创建用户程序

**第三阶段：深入优化（持续）**
1. 优化调度算法（CFS）
2. 实现虚拟内存高级特性（COW、swap）
3. 添加网络支持
4. 探索多核支持

### 学习方法

**对于每个模块：**
1. **理论学习**：阅读相关章节（推荐《Operating System Concepts》）
2. **代码阅读**：研究 Linux 0.11 或 xv6 的实现
3. **动手实践**：在 Zonix 中实现该功能
4. **测试验证**：编写测试用例
5. **文档记录**：写下实现思路和遇到的问题

**调试技巧：**
- 使用 GDB：`make debug-qemu`
- 使用 Bochs 调试：`make debug-bochs`
- 添加 `cprintf` 调试输出
- 查看反汇编：`obj/kernel.asm`

**推荐资源：**
- 书籍：《Operating System Concepts》（恐龙书）
- 书籍：《Understanding the Linux Kernel》
- 项目：xv6（MIT 教学 OS）
- 项目：Linux 0.11
- 网站：OSDev Wiki
- 课程：MIT 6.828、清华 uCore

---

## 🔧 开发工具配置

### 基础环境
```bash
# 当前已安装（参考 README.md）
sudo apt install make gcc nasm bochs-x

# 推荐额外安装
sudo apt install gdb qemu-system-x86 
sudo apt install clang-format cppcheck
```

### 调试配置
- GDB 配置：`tools/gdbinit`
- Bochs 配置：`bochsrc.bxrc`、`bochsrc_debug.bxrc`
- QEMU 调试：参考 `Makefile` 的 `debug-qemu` 目标

### 代码编辑器
推荐使用 VS Code 并安装插件：
- C/C++ (Microsoft)
- Makefile Tools
- x86 and x86_64 Assembly

---

## 📊 进度追踪

### 统计信息
- **总任务数**：约 150+ 个子任务
- **预计完成时间**：6-12 个月（取决于学习深度）
- **当前完成度**：约 18%（基础框架 + 中断优化 + 磁盘驱动）
- **最近完成**：键盘响应性能优化 (2025-10-14)

### 里程碑

- [ ] **Milestone 1**：能够运行简单的用户程序
- [ ] **Milestone 2**：实现基本的文件系统操作
- [ ] **Milestone 3**：支持多进程并发
- [ ] **Milestone 4**：实现完整的 Shell
- [ ] **Milestone 5**：支持网络通信
- [ ] **Milestone 6**：迁移到 64 位

---

## 📝 附录

### 项目结构
```
zonix/
├── boot/          # 引导加载程序
├── kern/          # 内核代码
│   ├── arch/      # 架构相关
│   ├── cons/      # 控制台和 Shell
│   ├── debug/     # 调试工具
│   ├── drivers/   # 设备驱动
│   ├── mm/        # 内存管理
│   ├── sched/     # 调度器
│   └── trap/      # 中断处理
├── include/       # 公共头文件
├── tools/         # 构建工具
├── docs/          # 文档
└── tests/         # 测试（待创建）
```

### 重要文件
- `Makefile`：构建系统
- `tools/kernel.ld`：内核链接脚本
- `tools/boot.ld`：引导程序链接脚本
- `kern/mm/pmm.c`：物理内存管理
- `kern/trap/trap.c`：中断处理
- `kern/cons/shell.c`：Shell 实现

---

## 📄 许可证

本项目采用 MIT 许可证，详见 `LICENSE`。

