name: Sync to Public Repository

on:
  workflow_dispatch:
    inputs:
      dry_run:
        description: 'Dry run (preview changes without pushing)'
        required: false
        default: 'false'
        type: choice
        options:
          - 'true'
          - 'false'

jobs:
  sync:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout private repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # èŽ·å–å®Œæ•´åŽ†å²ä»¥ä¾¿å¯¹æ¯”
          token: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Setup Git config
        run: |
          git config --global user.name "GitHub Actions Bot"
          git config --global user.email "actions@github.com"
      
      - name: Add public repository as remote
        run: |
          git remote add public git@github.com:leafvmaple/zonix.git || true
          git remote set-url public git@github.com:leafvmaple/zonix.git
      
      - name: Setup SSH key for public repository
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.PUBLIC_REPO_SSH_KEY }}
      
      - name: Fetch public repository
        run: |
          git fetch public || echo "Warning: Could not fetch public repository (may be empty)"
      
      - name: Compare repositories and generate diff
        id: compare
        run: |
          echo "## Repository Comparison" > comparison.md
          echo "" >> comparison.md
          
          # èŽ·å–å…¬å…±ä»“åº“çš„æœ€æ–°æäº¤ï¼ˆå¤„ç†ç©ºä»“åº“æƒ…å†µï¼‰
          PUBLIC_COMMIT=""
          if git rev-parse --verify public/main >/dev/null 2>&1; then
            PUBLIC_COMMIT=$(git rev-parse public/main)
          elif git rev-parse --verify public/master >/dev/null 2>&1; then
            PUBLIC_COMMIT=$(git rev-parse public/master)
          fi
          PRIVATE_COMMIT=$(git rev-parse HEAD)
          
          echo "Public repo commit: $PUBLIC_COMMIT" >> comparison.md
          echo "Private repo commit: $PRIVATE_COMMIT" >> comparison.md
          echo "" >> comparison.md
          
          if [ -z "$PUBLIC_COMMIT" ]; then
            echo "âš ï¸ Public repository appears to be empty or unreachable" >> comparison.md
            echo "Will push entire repository..." >> comparison.md
            HAS_CHANGES=true
          else
            # æ£€æŸ¥æ˜¯å¦æœ‰å·®å¼‚
            if git diff --quiet $PUBLIC_COMMIT HEAD; then
              echo "âœ… No differences found between repositories" >> comparison.md
              HAS_CHANGES=false
            else
              echo "ðŸ“Š Differences found!" >> comparison.md
              echo "" >> comparison.md
              HAS_CHANGES=true
              
              # ç»Ÿè®¡å·®å¼‚
              echo "### File Statistics" >> comparison.md
              echo '```' >> comparison.md
              git diff --stat $PUBLIC_COMMIT HEAD >> comparison.md
              echo '```' >> comparison.md
              echo "" >> comparison.md
              
              # æ”¶é›†æäº¤æ—¥å¿—
              echo "### Commit History (commits not in public repo)" >> comparison.md
              echo '```' >> comparison.md
              git log $PUBLIC_COMMIT..HEAD --oneline >> comparison.md
              echo '```' >> comparison.md
              echo "" >> comparison.md
              
              # ç”Ÿæˆè¯¦ç»†çš„æäº¤ä¿¡æ¯ç”¨äºŽåˆå¹¶
              echo "### Detailed Commit Messages" >> comparison.md
              git log $PUBLIC_COMMIT..HEAD --pretty=format:"- %s (%h - %an, %ad)" --date=short >> comparison.md
              echo "" >> comparison.md
            fi
          fi
          
          echo "has_changes=$HAS_CHANGES" >> $GITHUB_OUTPUT
          
          cat comparison.md
      
      - name: Generate consolidated commit message
        if: steps.compare.outputs.has_changes == 'true'
        id: commit_msg
        run: |
          # èŽ·å–å…¬å…±ä»“åº“çš„æœ€æ–°æäº¤
          PUBLIC_COMMIT=""
          if git rev-parse --verify public/main >/dev/null 2>&1; then
            PUBLIC_COMMIT=$(git rev-parse public/main)
          elif git rev-parse --verify public/master >/dev/null 2>&1; then
            PUBLIC_COMMIT=$(git rev-parse public/master)
          fi
          
          # åˆ›å»ºåˆå¹¶æäº¤ä¿¡æ¯
          if [ -n "$PUBLIC_COMMIT" ]; then
            # å¢žé‡åŒæ­¥ï¼šæ±‡æ€»å·®å¼‚æœŸé—´çš„æäº¤æ—¥å¿—
            cat > commit_message.txt <<'COMMIT_MSG'
          Sync from private repository
          
          This commit consolidates changes from the private repository.
          
          Changes summary:
          COMMIT_MSG
            echo "" >> commit_message.txt
            git log $PUBLIC_COMMIT..HEAD --pretty=format:"- %s" >> commit_message.txt
            echo "" >> commit_message.txt
            echo "" >> commit_message.txt
            echo "Files changed:" >> commit_message.txt
            git diff --stat $PUBLIC_COMMIT HEAD >> commit_message.txt
          else
            # é¦–æ¬¡åŒæ­¥ï¼šåªå†™åŠŸèƒ½è¯´æ˜Ž
            cat > commit_message.txt <<'COMMIT_MSG'
          Initial commit: Zonix Operating System
          
          Zonix is a minimal x86 operating system kernel featuring:
          
          - Bootloader with protected mode initialization
          - Memory management (PMM with first-fit, VMM with paging)
          - Interrupt handling (IDT, PIC, PIT)
          - Device drivers (CGA, keyboard, hard disk)
          - Process scheduling framework
          - Swap system with FIFO algorithm
          - Shell console interface
          - System call interface
          
          Architecture: x86 (32-bit)
          Build system: Make + GNU toolchain
          Emulator support: Bochs, QEMU
          COMMIT_MSG
          fi
          
          cat commit_message.txt
      
      - name: Create new commit with squashed changes
        if: steps.compare.outputs.has_changes == 'true'
        run: |
          # èŽ·å–å…¬å…±ä»“åº“çš„æœ€æ–°æäº¤
          PUBLIC_COMMIT=""
          if git rev-parse --verify public/main >/dev/null 2>&1; then
            PUBLIC_COMMIT=$(git rev-parse public/main)
          elif git rev-parse --verify public/master >/dev/null 2>&1; then
            PUBLIC_COMMIT=$(git rev-parse public/master)
          fi
          
          if [ -z "$PUBLIC_COMMIT" ]; then
            # é¦–æ¬¡åŒæ­¥ï¼šåˆ›å»ºå…¨æ–°çš„å­¤ç«‹åˆ†æ”¯
            echo "ï¿½ Creating initial commit for public repository..."
            
            # åˆ›å»ºå­¤ç«‹åˆ†æ”¯ï¼ˆæ²¡æœ‰åŽ†å²è®°å½•ï¼‰
            git checkout --orphan public-sync
            
            # æ·»åŠ æ‰€æœ‰æ–‡ä»¶
            git add -A
            
            # ç§»é™¤ workflow ç›¸å…³æ–‡ä»¶ï¼ˆå¯¹å…¬å…±ä»“åº“æ— æ„ä¹‰ï¼‰
            git reset HEAD .github/workflows/ 2>/dev/null || true
            git clean -fd .github/workflows/ 2>/dev/null || true
            
            # åˆ›å»ºåˆå§‹æäº¤
            git commit -F commit_message.txt
            
            echo "âœ… Created initial commit without history (workflows excluded)"
          else
            # å¢žé‡åŒæ­¥ï¼šåŸºäºŽå…¬å…±ä»“åº“åˆ›å»ºæ–°æäº¤
            echo "ðŸ“¦ Creating consolidated commit..."
            
            # åˆ‡æ¢åˆ°å…¬å…±ä»“åº“çš„æœ€æ–°çŠ¶æ€
            git checkout -b public-sync public/main || git checkout -b public-sync public/master
            
            # å¤åˆ¶ç§æœ‰ä»“åº“çš„æ‰€æœ‰æ–‡ä»¶ï¼ˆä½¿ç”¨ git checkout èŽ·å–æ–‡ä»¶å†…å®¹ï¼‰
            git checkout ${GITHUB_SHA} -- .
            
            # ç§»é™¤ workflow ç›¸å…³æ–‡ä»¶ï¼ˆå¯¹å…¬å…±ä»“åº“æ— æ„ä¹‰ï¼‰
            git rm -rf .github/workflows/ 2>/dev/null || true
            git reset HEAD .github/workflows/ 2>/dev/null || true
            git clean -fd .github/workflows/ 2>/dev/null || true
            
            # æ£€æŸ¥æ˜¯å¦æœ‰å˜åŒ–
            if git diff --cached --quiet && git diff --quiet; then
              echo "âš ï¸ No changes to commit"
              exit 0
            fi
            
            # æ·»åŠ æ‰€æœ‰å˜æ›´
            git add -A
            
            # åˆ›å»ºåˆå¹¶æäº¤
            git commit -F commit_message.txt
            
            echo "âœ… Created consolidated commit (workflows excluded)"
          fi
      
      - name: Push to public repository
        if: steps.compare.outputs.has_changes == 'true' && github.event.inputs.dry_run == 'false'
        run: |
          echo "ðŸ“¤ Pushing to public repository..."
          git push public public-sync:main --force
          echo "âœ… Successfully pushed to public repository"
      
      - name: Upload comparison report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: sync-comparison-report
          path: |
            comparison.md
            commit_message.txt
          retention-days: 30
      
      - name: Summary
        if: always()
        run: |
          echo "## Sync Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ "${{ steps.compare.outputs.has_changes }}" == "true" ]; then
            if [ "${{ github.event.inputs.dry_run }}" == "true" ]; then
              echo "ðŸ” **Dry Run Mode** - No changes were pushed" >> $GITHUB_STEP_SUMMARY
            else
              echo "âœ… **Sync Completed** - Changes pushed to public repository" >> $GITHUB_STEP_SUMMARY
            fi
          else
            echo "â„¹ï¸ **No Changes** - Repositories are already in sync" >> $GITHUB_STEP_SUMMARY
          fi
          
          echo "" >> $GITHUB_STEP_SUMMARY
          cat comparison.md >> $GITHUB_STEP_SUMMARY
